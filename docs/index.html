<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UK Tax Optimizer</title>
    <style>
        :root { --primary: #0066CC; --success: #10B981; --warning: #F59E0B; --danger: #EF4444; --background: #F9FAFB; --card: #FFFFFF; --text: #1F2937; --text-secondary: #6B7280; --border: #E5E7EB; --radius: 16px; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--background); color: var(--text); min-height: 100vh; padding-bottom: 80px; }
        .header { background: var(--card); padding: 16px 20px; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; font-weight: 600; }
        .tabs { display: flex; background: var(--card); border-bottom: 1px solid var(--border); position: sticky; top: 60px; z-index: 99; overflow-x: auto; }
        .tab { flex: 0 0 auto; padding: 12px 16px; text-align: center; font-size: 12px; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab svg { display: block; margin: 0 auto 4px; width: 24px; height: 24px; }
        .content { display: none; padding: 16px; }
        .content.active { display: block; }
        .card { background: var(--card); border-radius: var(--radius); padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow); }
        .card-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .summary-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .summary-item:last-child { border-bottom: none; }
        .summary-label { font-size: 14px; color: var(--text-secondary); }
        .summary-value { font-size: 18px; font-weight: 600; }
        .summary-value.green { color: var(--success); }
        .summary-value.red { color: var(--danger); }
        .summary-value.blue { color: var(--primary); }
        .summary-value.orange { color: var(--warning); }
        .income-item { display: flex; align-items: center; padding: 12px; background: var(--background); border-radius: 12px; margin-bottom: 8px; }
        .income-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 18px; }
        .income-icon.salary { background: #DBEAFE; }
        .income-icon.interest { background: #FEF3C7; }
        .income-icon.dividend { background: #D1FAE5; }
        .income-icon.capital { background: #FCE7F3; }
        .income-icon.rental { background: #E0E7FF; }
        .income-icon.ni { background: #FEF3C7; }
        .income-info { flex: 1; }
        .income-type { font-size: 14px; font-weight: 500; }
        .income-amount { font-size: 16px; font-weight: 600; color: var(--success); margin-right: 12px; }
        .delete-btn { width: 32px; height: 32px; border: none; background: none; color: var(--danger); cursor: pointer; font-size: 18px; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 24px; border-radius: 12px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--background); color: var(--text); border: 1px solid var(--border); }
        .btn-add { background: var(--primary); color: white; padding: 8px 16px; border-radius: 8px; font-size: 13px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        .form-input { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 12px; font-size: 16px; background: var(--card); }
        .form-select { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 12px; font-size: 16px; background: var(--card); }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card); border-radius: var(--radius); width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 24px; color: var(--text-secondary); cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; gap: 12px; }
        .modal-footer .btn { flex: 1; }
        .empty { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .lang-toggle { position: fixed; top: 16px; right: 16px; z-index: 101; display: flex; gap: 4px; }
        .lang-btn { padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; border: 1px solid var(--border); background: var(--card); }
        .lang-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .suggestion-item { background: var(--background); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
        .suggestion-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .suggestion-title { font-size: 14px; font-weight: 600; }
        .suggestion-badge { font-size: 10px; padding: 4px 8px; border-radius: 10px; font-weight: 500; }
        .suggestion-badge.high { background: #FEE2E2; color: #DC2626; }
        .suggestion-badge.medium { background: #FEF3C7; color: #D97706; }
        .suggestion-desc { font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
        .suggestion-savings { font-size: 14px; color: var(--success); font-weight: 600; }
        .rate-card { background: var(--background); border-radius: 12px; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .rate-name { font-size: 14px; }
        .rate-value { font-size: 16px; font-weight: 600; color: var(--primary); }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border); }
        .toggle { width: 48px; height: 28px; border-radius: 14px; background: var(--border); position: relative; cursor: pointer; }
        .toggle.active { background: var(--primary); }
        .toggle::after { content: ''; position: absolute; width: 22px; height: 22px; border-radius: 50%; background: white; top: 3px; left: 3px; transition: transform 0.2s; }
        .toggle.active::after { transform: translateX(20px); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        .ni-badge { background: #FEF3C7; color: #D97706; padding: 2px 8px; border-radius: 8px; font-size: 11px; margin-left: 8px; }
    </style>
</head>
<body>
    <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLang('en')">EN</button>
        <button class="lang-btn" onclick="setLang('zh')">‰∏≠Êñá</button>
    </div>

    <header class="header">
        <h1>üá¨üáß UK Tax Optimizer</h1>
    </header>

    <nav class="tabs">
        <div class="tab active" onclick="switchTab('calc')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/></svg>
            <span data-i18n="tab_calc">Calculator</span>
        </div>
        <div class="tab" onclick="switchTab('optimize')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3"/></svg>
            <span data-i18n="tab_optimize">Optimize</span>
        </div>
        <div class="tab" onclick="switchTab('guide')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 6.042A8.967 8.967 0 006 6a8.967 8.967 0 00-6 6.042"/></svg>
            <span data-i18n="tab_guide">Guide</span>
        </div>
        <div class="tab" onclick="switchTab('settings')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/></svg>
            <span data-i18n="tab_settings">Settings</span>
        </div>
    </nav>

    <div id="tab-calc" class="content active">
        <div class="card animate-in">
            <div class="card-title"><span data-i18n="summary_title">Your Tax Summary</span></div>
            <div class="summary-item"><span class="summary-label" data-i18n="gross_income">Gross Income</span><span class="summary-value blue" id="gross-income">¬£0</span></div>
            <div class="summary-item"><span class="summary-label" data-i18n="income_tax">Income Tax</span><span class="summary-value red" id="income-tax">¬£0</span></div>
            <div class="summary-item"><span class="summary-label"><span class="ni-badge">NI</span> <span data-i18n="national_insurance">National Insurance</span></span><span class="summary-value orange" id="national-insurance">¬£0</span></div>
            <div class="summary-item"><span class="summary-label" data-i18n="total_tax">Total Tax</span><span class="summary-value red" id="total-tax">¬£0</span></div>
            <div class="summary-item"><span class="summary-label" data-i18n="net_income">Net Income</span><span class="summary-value green" id="net-income">¬£0</span></div>
            <div class="summary-item"><span class="summary-label" data-i18n="effective_rate">Effective Rate</span><span class="summary-value" id="effective-rate">0%</span></div>
        </div>

        <div class="card animate-in">
            <div class="card-title"><span data-i18n="income_sources">Income Sources</span><button class="btn btn-add" onclick="openModal('income')">+ Add</button></div>
            <div id="income-list"><div class="empty"><p data-i18n="no_income">No income added yet</p></div></div>
        </div>

        <div class="card animate-in">
            <div class="card-title"><span data-i18n="deductions">Deductions</span><button class="btn btn-add" onclick="openModal('deduction')">+ Add</button></div>
            <div id="deduction-list"><div class="empty"><p data-i18n="no_deductions">No deductions added yet</p></div></div>
        </div>
    </div>

    <div id="tab-optimize" class="content">
        <div class="card animate-in">
            <div class="card-title" data-i18n="optimization_tips">Tax Optimization Tips</div>
            <div id="suggestions-list"><div class="empty"><p data-i18n="add_income_tips">Add income to see suggestions</p></div></div>
        </div>
    </div>

    <div id="tab-guide" class="content">
        <div class="card animate-in">
            <div class="card-title" data-i18n="income_tax_rates">Income Tax Rates (2024/25)</div>
            <div class="rate-card"><span class="rate-name">Personal Allowance</span><span class="rate-value">¬£12,570 @ 0%</span></div>
            <div class="rate-card"><span class="rate-name">Basic Rate</span><span class="rate-value">¬£12,571-50,270 @ 20%</span></div>
            <div class="rate-card"><span class="rate-name">Higher Rate</span><span class="rate-value">¬£50,271-125,140 @ 40%</span></div>
            <div class="rate-card"><span class="rate-name">Additional Rate</span><span class="rate-value">Over ¬£125,140 @ 45%</span></div>
        </div>
        <div class="card animate-in">
            <div class="card-title" data-i18n="ni_rates">National Insurance (2024/25)</div>
            <div class="rate-card"><span class="rate-name">Class 1 (Employee) 8%</span><span class="rate-value">¬£12,570-50,270</span></div>
            <div class="rate-card"><span class="rate-name">Class 1 (Employee) 2%</span><span class="rate-value">Over ¬£50,270</span></div>
            <div class="rate-card"><span class="rate-name">Class 4 (Self) 9%</span><span class="rate-value">¬£12,570-50,270</span></div>
            <div class="rate-card"><span class="rate-name">Class 4 (Self) 2%</span><span class="rate-value">Over ¬£50,270</span></div>
        </div>
        <div class="card animate-in">
            <div class="card-title" data-i18n="annual_allowances">Annual Allowances</div>
            <div class="knowledge-grid">
                <div class="knowledge-item"><div class="knowledge-icon">üè¶</div><div class="knowledge-label">ISA<br>¬£20,000</div></div>
                <div class="knowledge-item"><div class="knowledge-icon">üíº</div><div class="knowledge-label">Pension<br>¬£60,000</div></div>
                <div class="knowledge-item"><div class="knowledge-icon">üìà</div><div class="knowledge-label">CGT<br>¬£3,000</div></div>
                <div class="knowledge-item"><div class="knowledge-icon">üí∞</div><div class="knowledge-label">Dividend<br>¬£500</div></div>
                <div class="knowledge-item"><div class="knowledge-icon">üíµ</div><div class="knowledge-label">PSA<br>¬£1,000</div></div>
                <div class="knowledge-item"><div class="knowledge-icon">üõí</div><div class="knowledge-label">Trading<br>¬£1,000</div></div>
            </div>
        </div>
    </div>

    <div id="tab-settings" class="content">
        <div class="card animate-in">
            <div class="card-title" data-i18n="tax_settings">Tax Settings</div>
            <div class="settings-item"><span data-i18n="tax_year">Tax Year</span>
                <select class="form-select" style="width:auto;" id="tax-year-select" onchange="updateTaxYear()">
                    <option value="2024/25">2024/25</option><option value="2025/26">2025/26</option>
                </select>
            </div>
            <div class="settings-item"><span data-i18n="scottish_taxpayer">Scottish Taxpayer</span><div class="toggle" id="scottish-toggle" onclick="toggleScottish()"></div></div>
            <div class="settings-item"><span data-i18n="self_employed">Self-Employed</span><div class="toggle" id="self-toggle" onclick="toggleSelf()"></div></div>
        </div>
        <div class="card animate-in">
            <div class="card-title" data-i18n="data">Data</div>
            <div class="settings-item" onclick="clearAllData()" style="cursor:pointer;"><span style="color:var(--danger);" data-i18n="clear_all">Clear All Data</span></div>
        </div>
    </div>

    <div id="modal-income" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span class="modal-title" data-i18n="add_income">Add Income</span><button class="modal-close" onclick="closeModal('income')">&times;</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label" data-i18n="income_type">Income Type</label>
                    <select class="form-select" id="income-type">
                        <option value="salary" data-i18n="income_salary">Salary (Employment)</option>
                        <option value="self" data-i18n="income_self">Self-Employment Profit</option>
                        <option value="interest" data-i18n="income_interest">Interest</option>
                        <option value="dividend" data-i18n="income_dividend">Dividend</option>
                        <option value="capital" data-i18n="income_capital">Capital Gains</option>
                        <option value="rental" data-i18n="income_rental">Rental</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label" data-i18n="amount">Amount (¬£)</label><input type="number" class="form-input" id="income-amount" placeholder="0"></div>
                <div class="form-group"><label class="form-label" data-i18n="description">Description</label><input type="text" class="form-input" id="income-desc" placeholder=""></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('income')" data-i18n="cancel">Cancel</button><button class="btn btn-primary" onclick="saveIncome()" data-i18n="save">Save</button></div>
        </div>
    </div>

    <div id="modal-deduction" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span class="modal-title" data-i18n="add_deduction">Add Deduction</span><button class="modal-close" onclick="closeModal('deduction')">&times;</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label" data-i18n="deduction_type">Deduction Type</label>
                    <select class="form-select" id="deduction-type">
                        <option value="pension" data-i18n="deduction_pension">Pension Contribution</option>
                        <option value="gift" data-i18n="deduction_gift">Gift Aid</option>
                        <option value="trading" data-i18n="deduction_trading">Trading Allowance</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label" data-i18n="amount">Amount (¬£)</label><input type="number" class="form-input" id="deduction-amount" placeholder="0"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('deduction')" data-i18n="cancel">Cancel</button><button class="btn btn-primary" onclick="saveDeduction()" data-i18n="save">Save</button></div>
        </div>
    </div>

    <script>
        const translations = {
            en: { tab_calc:'Calculator',tab_optimize:'Optimize',tab_guide:'Guide',tab_settings:'Settings',summary_title:'Your Tax Summary',gross_income:'Gross Income',income_tax:'Income Tax',national_insurance:'National Insurance',total_tax:'Total Tax',net_income:'Net Income',effective_rate:'Effective Rate',income_sources:'Income Sources',deductions:'Deductions',no_income:'No income added yet',no_deductions:'No deductions added yet',add_income_tips:'Add income to see suggestions',optimization_tips:'Tax Optimization Tips',income_tax_rates:'Income Tax Rates (2024/25)',national_insurance:'National Insurance',ni_rates:'National Insurance (2024/25)',annual_allowances:'Annual Allowances',tax_settings:'Tax Settings',tax_year:'Tax Year',scottish_taxpayer:'Scottish Taxpayer',self_employed:'Self-Employed',data:'Data',clear_all:'Clear All Data',add_income:'Add Income',income_type:'Income Type',amount:'Amount (¬£)',description:'Description (optional)',save:'Save',cancel:'Cancel',add_deduction:'Add Deduction',deduction_type:'Deduction Type',income_salary:'Salary',income_self:'Self-Employment',income_interest:'Interest',income_dividend:'Dividend',income_capital:'Capital Gains',income_rental:'Rental',deduction_pension:'Pension Contribution',deduction_gift:'Gift Aid',deduction_trading:'Trading Allowance' },
            zh: { tab_calc:'ËÆ°ÁÆóÂô®',tab_optimize:'‰ºòÂåñ',tab_guide:'ÊåáÂçó',tab_settings:'ËÆæÁΩÆ',summary_title:'ÊÇ®ÁöÑÁ®éÂä°ÊëòË¶Å',gross_income:'ÊÄªÊî∂ÂÖ•',income_tax:'ÊâÄÂæóÁ®é',national_insurance:'ÂõΩÊ∞ë‰øùÈô©',total_tax:'ÊÄªÁ®éÊ¨æ',net_income:'ÂáÄÊî∂ÂÖ•',effective_rate:'ÊúâÊïàÁ®éÁéá',income_sources:'Êî∂ÂÖ•Êù•Ê∫ê',deductions:'Êâ£Èô§È°π',no_income:'ÊöÇÊó†Êî∂ÂÖ•ËÆ∞ÂΩï',no_deductions:'ÊöÇÊó†Êâ£Èô§ËÆ∞ÂΩï',add_income_tips:'Ê∑ªÂä†Êî∂ÂÖ•‰ª•Êü•ÁúãÂª∫ËÆÆ',optimization_tips:'Á®éÂä°‰ºòÂåñÂª∫ËÆÆ',income_tax_rates:'ÊâÄÂæóÁ®éÁéá (2024/25)',national_insurance:'ÂõΩÊ∞ë‰øùÈô©',ni_rates:'ÂõΩÊ∞ë‰øùÈô©Ë¥πÁéá (2024/25)',annual_allowances:'Âπ¥Â∫¶ÂÖçÁ®éÈ¢ù',tax_settings:'Á®éÂä°ËÆæÁΩÆ',tax_year:'Á®éÂä°Âπ¥Â∫¶',scottish_taxpayer:'ËãèÊ†ºÂÖ∞Á∫≥Á®é‰∫∫',self_employed:'Ëá™Èõá‰∫∫Â£´',data:'Êï∞ÊçÆ',clear_all:'Ê∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆ',add_income:'Ê∑ªÂä†Êî∂ÂÖ•',income_type:'Êî∂ÂÖ•Á±ªÂûã',amount:'ÈáëÈ¢ù (¬£)',description:'ÊèèËø∞ÔºàÂèØÈÄâÔºâ',save:'‰øùÂ≠ò',cancel:'ÂèñÊ∂à',add_deduction:'Ê∑ªÂä†Êâ£Èô§',deduction_type:'Êâ£Èô§Á±ªÂûã',income_salary:'Â∑•ËµÑ',income_self:'Ëá™ÈõáÁõàÂà©',income_interest:'Âà©ÊÅØ',income_dividend:'ËÇ°ÊÅØ',income_capital:'ËµÑÊú¨Êî∂Áõä',income_rental:'ÁßüÈáë',deduction_pension:'ÂÖªËÄÅÈáë‰æõÊ¨æ',deduction_gift:'ÊÖàÂñÑÊçêÊ¨æ',deduction_trading:'Ëê•‰∏öÂÖçÁ®éÈ¢ù' }
        };
        let state = { incomes:[],deductions:[],taxYear:'2024/25',isScottish:false,isSelfEmployed:false,lang:'en' };
        const iconMap = { salary:'üí∞',self:'üíº',interest:'üíµ',dividend:'üìä',capital:'üìà',rental:'üè†' };
        const typeLabels = { en:{salary:'Salary',self:'Self-Employment',interest:'Interest',dividend:'Dividend',capital:'Capital Gains',rental:'Rental'},zh:{salary:'Â∑•ËµÑ',self:'Ëá™Èõá',interest:'Âà©ÊÅØ',dividend:'ËÇ°ÊÅØ',capital:'ËµÑÊú¨Êî∂Áõä',rental:'ÁßüÈáë'} };
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }
        
        function setLang(lang) {
            state.lang = lang;
            document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
            document.querySelector(`.lang-btn[onclick="setLang('${lang}')"]`).classList.add('active');
            document.querySelectorAll('[data-i18n]').forEach(el=>el.textContent = translations[lang][el.dataset.i18n] || el.textContent);
            renderAll();
        }
        
        function calculateTax() {
            const PA = 12570, BR = 50270, HR = 125140;
            const BR_RATE = 0.20, HR_RATE = 0.40, AR_RATE = 0.45;
            
            // Income tax calculation
            let totalIncome = state.incomes.reduce((s,i)=>s+i.amount,0) - state.deductions.reduce((s,d)=>s+d.amount,0);
            let taxableIncome = Math.max(0, totalIncome - PA);
            let incomeTax = 0;
            if(taxableIncome <= BR-PA) incomeTax = taxableIncome * BR_RATE;
            else if(taxableIncome <= HR-PA) incomeTax = (BR-PA)*BR_RATE + (taxableIncome-(BR-PA))*HR_RATE;
            else incomeTax = (BR-PA)*BR_RATE + (HR-BR)*HR_RATE + (taxableIncome-(HR-PA))*AR_RATE;
            
            // National Insurance calculation
            let ni = 0;
            const salaryIncome = state.incomes.filter(i=>i.type==='salary').reduce((s,i)=>s+i.amount,0);
            const selfIncome = state.incomes.filter(i=>i.type==='self').reduce((s,i)=>s+i.amount,0);
            
            if(salaryIncome > 0) {
                const niable = Math.max(0, salaryIncome - 12570);
                if(niable <= BR-PA) ni += niable * 0.08;
                else ni += (BR-PA)*0.08 + (niable-(BR-PA)) * 0.02;
            }
            
            if(selfIncome > 0 && state.isSelfEmployed) {
                const niable = Math.max(0, selfIncome - 12570);
                if(niable <= BR-PA) ni += niable * 0.09;
                else ni += (BR-PA)*0.09 + (niable-(BR-PA)) * 0.02;
            }
            
            let totalTax = incomeTax + ni;
            let net = totalIncome - totalTax;
            let effective = totalIncome > 0 ? (totalTax/totalIncome)*100 : 0;
            
            return { gross:totalIncome, incomeTax, ni, totalTax, net, effective };
        }
        
        function renderAll() {
            const r = calculateTax();
            document.getElementById('gross-income').textContent = `¬£${Math.round(r.gross).toLocaleString()}`;
            document.getElementById('income-tax').textContent = `¬£${Math.round(r.incomeTax).toLocaleString()}`;
            document.getElementById('national-insurance').textContent = `¬£${Math.round(r.ni).toLocaleString()}`;
            document.getElementById('total-tax').textContent = `¬£${Math.round(r.totalTax).toLocaleString()}`;
            document.getElementById('net-income').textContent = `¬£${Math.round(r.net).toLocaleString()}`;
            document.getElementById('effective-rate').textContent = `${r.effective.toFixed(1)}%`;
            
            const list = document.getElementById('income-list');
            list.innerHTML = state.incomes.length ? state.incomes.map((i,idx)=>
                `<div class="income-item animate-in"><div class="income-icon ${i.type}">${iconMap[i.type]}</div><div class="income-info"><div class="income-type">${typeLabels[state.lang][i.type]}</div>${i.desc?`<div class="income-desc">${i.desc}</div>`:''}</div><div class="income-amount">+¬£${Math.round(i.amount).toLocaleString()}</div><button class="delete-btn" onclick="deleteIncome(${idx})">√ó</button></div>`).join('') : `<div class="empty"><p data-i18n="no_income">${translations[state.lang].no_income}</p></div>`;
            
            const dlist = document.getElementById('deduction-list');
            dlist.innerHTML = state.deductions.length ? state.deductions.map((d,idx)=>
                `<div class="income-item animate-in" style="background:#FEF3C7"><div class="income-icon" style="background:#FDE68A">‚ûñ</div><div class="income-info"><div class="income-type">${d.type==='pension'?'Pension':d.type==='gift'?'Gift Aid':'Trading'}</div></div><div class="income-amount" style="color:var(--danger)">-¬£${Math.round(d.amount).toLocaleString()}</div><button class="delete-btn" onclick="deleteDeduction(${idx})">√ó</button></div>`).join('') : `<div class="empty"><p data-i18n="no_deductions">${translations[state.lang].no_deductions}</p></div>`;
            
            renderSuggestions();
        }
        
        function renderSuggestions() {
            const s = document.getElementById('suggestions-list');
            if(state.incomes.length === 0) {
                s.innerHTML = `<div class="empty"><p data-i18n="add_income_tips">${translations[state.lang].add_income_tips}</p></div>`;
                return;
            }
            const total = state.incomes.reduce((s,i)=>s+i.amount,0);
            const salary = state.incomes.filter(i=>i.type==='salary').reduce((s,i)=>s+i.amount,0);
            let tips = [];
            if(total > 12570) tips.push({title:state.lang==='en'?'Maximize ISA':'ÊúÄÂ§ßÂåñISA',desc:state.lang==='en'?'¬£20,000 tax-free allowance':'ÊØèÂπ¥¬£20,000ÂÖçÁ®éÈ¢ùÂ∫¶',savings:Math.min(20000,total*0.20),prio:'high'});
            if(salary > 50270) tips.push({title:state.lang==='en'?'Higher NI Rate':'È´òNIÁ®éÁéá',desc:state.lang==='en'?'NI drops to 2% over ¬£50,270':'Ë∂ÖËøá¬£50,270ÂêéNIÈôçËá≥2%',savings:0,prio:'medium'});
            if(salary > 0) tips.push({title:state.lang==='en'?'Pension Relief':'ÂÖªËÄÅÈáëÈÄÄÁ®é',desc:state.lang==='en'?'Save NI + Tax on contributions':'ÂÖªËÄÅÈáëÁº¥Á∫≥ÂèØÁúÅNI+ÊâÄÂæóÁ®é',savings:Math.min(40000,salary*0.08+salary*0.20),prio:'high'});
            if(state.isSelfEmployed) tips.push({title:state.lang==='en'?'Class 2 NIC':'Class 2ÂõΩÊ∞ë‰øùÈô©',desc:state.lang==='en'?'¬£3.45/week flat rate optional':'ÂèØÈÄâÊã©ÊØèÂë®¬£3.45Âõ∫ÂÆöË¥πÁéá',savings:179,prio:'medium'});
            s.innerHTML = tips.map(t=>
                `<div class="suggestion-item animate-in"><div class="suggestion-header"><span class="suggestion-title">${t.title}</span><span class="suggestion-badge ${t.prio}">${t.prio==='high'?'High':'Medium'}</span></div><div class="suggestion-desc">${t.desc}</div>${t.savings?`<div class="suggestion-savings">¬£${Math.round(t.savings).toLocaleString()} ${state.lang==='en'?'potential savings':'ÊΩúÂú®ËäÇÁúÅ'}</div>`:''}</div>`).join('');
        }
        
        function openModal(type) { document.getElementById(`modal-${type}`).classList.add('active'); }
        function closeModal(type) { document.getElementById(`modal-${type}`).classList.remove('active'); }
        
        function saveIncome() {
            const type = document.getElementById('income-type').value;
            const amount = parseFloat(document.getElementById('income-amount').value);
            const desc = document.getElementById('income-desc').value;
            if(!amount) return;
            state.incomes.push({type,amount,desc});
            closeModal('income');
            document.getElementById('income-amount').value = '';
            document.getElementById('income-desc').value = '';
            renderAll();
            saveData();
        }
        
        function saveDeduction() {
            const type = document.getElementById('deduction-type').value;
            const amount = parseFloat(document.getElementById('deduction-amount').value);
            if(!amount) return;
            state.deductions.push({type,amount});
            closeModal('deduction');
            document.getElementById('deduction-amount').value = '';
            renderAll();
            saveData();
        }
        
        function deleteIncome(idx) { state.incomes.splice(idx,1); renderAll(); saveData(); }
        function deleteDeduction(idx) { state.deductions.splice(idx,1); renderAll(); saveData(); }
        
        function updateTaxYear() { state.taxYear = document.getElementById('tax-year-select').value; renderAll(); saveData(); }
        function toggleScottish() { state.isScottish = !state.isScottish; document.getElementById('scottish-toggle').classList.toggle('active',state.isScottish); saveData(); }
        function toggleSelf() { state.isSelfEmployed = !state.isSelfEmployed; document.getElementById('self-toggle').classList.toggle('active',state.isSelfEmployed); saveData(); }
        function clearAllData() { if(confirm(state.lang==='zh'?'Á°ÆÂÆöÊ∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆ?':'Clear all data?')) { state.incomes=[]; state.deductions=[]; renderAll(); saveData(); } }
        
        function saveData() { localStorage.setItem('ukTaxData', JSON.stringify(state)); }
        function loadData() { const d = localStorage.getItem('ukTaxData'); if(d) { state = JSON.parse(d); document.getElementById('tax-year-select').value = state.taxYear; document.getElementById('scottish-toggle').classList.toggle('active',state.isScottish); document.getElementById('self-toggle').classList.toggle('active',state.isSelfEmployed); renderAll(); } }
        
        loadData();
    </script>
</body>
</html>